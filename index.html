<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŸ Safari de Sonidos y Nombres ğŸš€</title>
    <link rel="stylesheet" href="styles.css"> 
</head>
<body onload="cargarPerfiles()">

    <div id="pantalla-inicio">
        <div class="inicio-contenedor">
        <h1>ğŸŒŸ SAFARI DE SONIDOS ğŸ¦</h1>
        <p>Â¡Inicia sesiÃ³n para guardar tu progreso!</p>
    
    <button class="btn-google" onclick="window.loginConGoogle()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
        Jugar con Google
    </button>

    <div style="margin: 20px 0; border-top: 2px dashed #eee;"></div>

    <p style="font-size: 0.9em; margin-bottom: 5px;">O juega en este dispositivo:</p>
    <div id="contenedor-select">
        <select id="select-perfil" class="select-personalizado" onchange="window.seleccionarPerfil()">
        </select>
        <a id="btn-eliminar-perfil" onclick="window.eliminarPerfil()">Eliminar Explorador</a>
    </div>

    <input type="text" id="input-nombre-nuevo" placeholder="Nombre del Explorador" maxlength="15" style="display: none;">
    <button class="btn-comenzar" onclick="window.iniciarJuego()">Â¡ENTRAR AL SAFARI!</button>
</div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h1 style="font-size: 50px;">ğŸ‰</h1>
            <h2 id="modal-titulo">Â¡Nivel Superado!</h2>
            <p id="modal-puntos">Puntos obtenidos en el nivel: 50</p>
            <button class="btn-comenzar" onclick="siguiente()">CONTINUAR</button>
        </div>
    </div>

    <div class="contenedor-principal" id="juego" style="display: none;">
        
        <div id="sidebar">
            <div class="perfil">
                <h3>Explorador</h3>
                <h2 id="nombre-jugador">---</h2>
            </div>
            
            <div class="categoria-btn desbloqueada" id="cat-granja" onclick="cambiarCategoria('granja')">
                <span>ğŸ¡ Granja</span>
                <div class="estrellas" id="star-granja">â˜†â˜†â˜†</div>
            </div>
            <div class="categoria-btn" id="cat-mar" onclick="cambiarCategoria('mar')">
                <span>ğŸŒŠ Mar ğŸ”’</span>
                <div class="estrellas" id="star-mar">â˜†â˜†â˜†</div>
            </div>
            <div class="categoria-btn" id="cat-selva" onclick="cambiarCategoria('selva')">
                <span>ğŸ¦ Selva ğŸ”’</span>
                <div class="estrellas" id="star-selva">â˜†â˜†â˜†</div>
            </div>
            <div class="categoria-btn" id="cat-desierto" onclick="cambiarCategoria('desierto')">
                <span>ğŸœï¸ Desierto ğŸ”’</span>
                <div class="estrellas" id="star-desierto">â˜†â˜†â˜†</div>
            </div>
            <div class="categoria-btn" id="cat-artico" onclick="cambiarCategoria('artico')">
                <span>ğŸ§Š Ãrtico ğŸ”’</span>
                <div class="estrellas" id="star-artico">â˜†â˜†â˜†</div>
            </div>
            <div class="categoria-btn" id="cat-bosque" onclick="cambiarCategoria('bosque')">
                <span>ğŸŒ³ Bosque ğŸ”’</span>
                <div class="estrellas" id="star-bosque">â˜†â˜†â˜†</div>
            </div>
            <div class="categoria-btn" id="cat-montana" onclick="cambiarCategoria('montana')">
                <span>â›°ï¸ MontaÃ±a ğŸ”’</span>
                <div class="estrellas" id="star-montana">â˜†â˜†â˜†</div>
            </div>
            <div class="categoria-btn" id="cat-rio" onclick="cambiarCategoria('rio')">
                <span>ğŸï¸ RÃ­o / Agua Dulce ğŸ”’</span>
                <div class="estrellas" id="star-rio">â˜†â˜†â˜†</div>
            </div>

            <div id="btn-menu-principal" onclick="volverAlMenu()">
                â¬…ï¸ Cambiar de Explorador
            </div>
        </div>

        <div id="area-juego">
            
            <div class="header-nivel">
                <div id="barra-progreso-stats">
                    
                    <div class="puntos-totales-lateral">
                        âœ¨ TOTAL<span id="puntuacion-total-lateral">0</span>
                    </div>

                    <div class="titulo-stats">
                        <span id="titulo-nivel-emoji">ğŸ¡</span> <span id="titulo-nivel">GRANJA - NIVEL 1</span>
                    </div>

                    <div class="stats-cajas">
                        <div class="stat-box" id="stat-puntos">
                            <div class="stat-label">PUNTOS NIVEL</div>
                            <div class="stat-valor" id="puntos-nivel">0</div>
                        </div>
                        <div class="stat-box" id="stat-meta">
                            <div class="stat-label">META</div>
                            <div class="stat-valor" id="meta-nivel">0</div>
                        </div>
                        <div class="stat-box" id="stat-listos">
                            <div class="stat-label">ANIMALES LISTOS</div>
                            <div class="stat-valor" id="listos-nivel">0/0</div>
                        </div>
                    </div>
                    
                    <div class="progreso-bar-contenedor">
                        <div id="progreso-bar">
                            <span id="progreso-porcentaje">0%</span>
                        </div>
                    </div>
                </div>
                <span id="instruccion">Â¡Arrastra la ficha correcta al animal!</span>
            </div>

            <div id="tablero"></div>
        </div>

        <div id="panel-opciones"></div>
    </div>

<script type="module">
    // --- 1. IMPORTAR FIREBASE (VersiÃ³n Web) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- 2. TU CONFIGURACIÃ“N (Tus claves reales) ---
    const firebaseConfig = {
        apiKey: "AIzaSyC-E0E2f41wRB3WOG2QjrPlfhOkGn1UjQc",
        authDomain: "safarisonidos.firebaseapp.com",
        projectId: "safarisonidos",
        storageBucket: "safarisonidos.firebasestorage.app",
        messagingSenderId: "539812546780",
        appId: "1:539812546780:web:453c1e20074f9bfac70c19"
    };

    // --- 3. INICIALIZAR FIREBASE (Solo una vez) ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // -----------------------------------------------------------
    // LÃ“GICA DEL JUEGO
    // -----------------------------------------------------------

    const GITHUB_URL = 'https://raw.githubusercontent.com/leonel20202005-stack/audiosJuego/main/';
    const NUM_ANIMALES_POR_NIVEL = 5; 
    
    // BASE DE DATOS
    const db = {
        granja: [
            { nombre: "Vaca",    sonido: "Muuu",     emoji: "ğŸ„", archivo: "vaca.mp3" }, 
            { nombre: "Cerdo",   sonido: "Oink",     emoji: "ğŸ·", archivo: "cerdo.mp3" },
            { nombre: "Gallo",   sonido: "KikirikÃ­", emoji: "ğŸ“", archivo: "gallo.mp3" }, 
            { nombre: "Oveja",   sonido: "Beeee",    emoji: "ğŸ‘", archivo: "oveja.mp3" },
            { nombre: "Pato",    sonido: "Cuac",     emoji: "ğŸ¦†", archivo: "pato.mp3" },
            { nombre: "Caballo", sonido: "Hiiiii",   emoji: "ğŸ´", archivo: "caballo.mp3" }, 
            { nombre: "Pavo",    sonido: "Glu Glu",  emoji: "ğŸ¦ƒ", archivo: "pavo.mp3" },
            { nombre: "Conejo",  sonido: "Sniff",    emoji: "ğŸ‡", archivo: "conejo.mp3" }, 
            { nombre: "Cabra",   sonido: "Meeeh",    emoji: "ğŸ", archivo: "cabra.mp3" },
            { nombre: "Ganso",   sonido: "Honk",     emoji: "ğŸ¦¢", archivo: "ganso.mp3" },
            { nombre: "Burro",   sonido: "Hiaaw",    emoji: "ğŸ«", archivo: "burro.mp3" }, 
            { nombre: "RatÃ³n",   sonido: "Squeak",   emoji: "ğŸ", archivo: "raton.mp3" },
            { nombre: "Gallina", sonido: "Cluck",    emoji: "ğŸ”", archivo: "gallina.mp3" }, 
            { nombre: "Abeja",   sonido: "Bzzzz",    emoji: "ğŸ", archivo: "abeja.mp3" },
            { nombre: "HÃ¡mster", sonido: "Chirp",    emoji: "ğŸ¹", archivo: "hamster.mp3" }
        ],
        mar: [
            { nombre: "Ballena Azul", sonido: "Uuuuh", emoji: "ğŸ‹" }, { nombre: "DelfÃ­n", sonido: "Click", emoji: "ğŸ¬" },
            { nombre: "Pulpo", sonido: "Blub", emoji: "ğŸ™" }, { nombre: "TiburÃ³n", sonido: "Chomp", emoji: "ğŸ¦ˆ" },
            { nombre: "Tortuga Marina", sonido: "Hiss", emoji: "ğŸ¢" },
            { nombre: "Langosta", sonido: "Snap", emoji: "ğŸ¦" }, { nombre: "CamarÃ³n", sonido: "Sshh", emoji: "ğŸ¦" },
            { nombre: "Medusa", sonido: "Jelly", emoji: "ğŸ¦‘" }, { nombre: "Foca ComÃºn", sonido: "Arf Arf", emoji: "ğŸ¦­" },
            { nombre: "Morsa", sonido: "Roar", emoji: "ğŸ¦­" },
            { nombre: "Estrella de Mar", sonido: "Shine", emoji: "â­" }, { nombre: "Hipocampo", sonido: "Glug", emoji: "ğŸ«" },
            { nombre: "Nutria de Mar", sonido: "Squeal", emoji: "ğŸ¦¦" }, { nombre: "Anguila ElÃ©ctrica", sonido: "Zap", emoji: "ğŸ" },
            { nombre: "Calamar", sonido: "Ink", emoji: "ğŸ¦‘" }
        ],
        selva: [
            { nombre: "LeÃ³n", sonido: "Roaar", emoji: "ğŸ¦" }, { nombre: "Mono", sonido: "Uuh-Ah", emoji: "ğŸµ" },
            { nombre: "Elefante", sonido: "Pauuu", emoji: "ğŸ˜" }, { nombre: "Tigre", sonido: "Grrr", emoji: "ğŸ¯" },
            { nombre: "Loro", sonido: "Hola", emoji: "ğŸ¦œ" },
            { nombre: "Cocodrilo", sonido: "Snap", emoji: "ğŸŠ" }, { nombre: "Gorila", sonido: "Ugh", emoji: "ğŸ¦" },
            { nombre: "Jirafa", sonido: "Mmm", emoji: "ğŸ¦’" }, { nombre: "Cebra", sonido: "Bray", emoji: "ğŸ¦“" },
            { nombre: "Rinoceronte", sonido: "Grunt", emoji: "ğŸ¦" },
            { nombre: "Panda", sonido: "Chew", emoji: "ğŸ¼" }, { nombre: "TucÃ¡n", sonido: "Croak", emoji: "ğŸ¦œ" },
            { nombre: "Perezoso", sonido: "Yawn", emoji: "ğŸ¦¥" }, { nombre: "ChimpancÃ©", sonido: "Hoot", emoji: "ğŸ’" },
            { nombre: "Ocelote", sonido: "Meow", emoji: "ğŸ†" }
        ],
        desierto: [
            { nombre: "Coyote", sonido: "Aullido", emoji: "ğŸº" }, { nombre: "Serpiente Cascabel", sonido: "Rattle", emoji: "ğŸ" },
            { nombre: "Camello", sonido: "Grunt", emoji: "ğŸª" }, { nombre: "Fenec", sonido: "Yelp", emoji: "ğŸ¦Š" },
            { nombre: "Correcaminos", sonido: "Beep", emoji: "ğŸ¦" },
            { nombre: "EscorpiÃ³n", sonido: "Click", emoji: "ğŸ¦‚" }, { nombre: "BÃºho del Desierto", sonido: "Hoo", emoji: "ğŸ¦‰" },
            { nombre: "Lagarto Monitor", sonido: "Scurry", emoji: "ğŸ¦" }, { nombre: "Hiena", sonido: "Risa", emoji: "ğŸ¦›" },
            { nombre: "Jerbo", sonido: "Chirp", emoji: "ğŸ" },
            { nombre: "Adax", sonido: "Sigh", emoji: "ğŸ" }, { nombre: "Dromedario", sonido: "Gurgle", emoji: "ğŸ«" },
            { nombre: "Suricata", sonido: "Watch", emoji: "ğŸ¦¦" }, { nombre: "TarÃ¡ntula", sonido: "Tap", emoji: "ğŸ•·ï¸" },
            { nombre: "Halcon Peregrino", sonido: "Screech", emoji: "ğŸ¦…" }
        ],
        artico: [
            { nombre: "Oso Polar", sonido: "Growl", emoji: "ğŸ»â€â„ï¸" }, { nombre: "Zorro Ãrtico", sonido: "Bark", emoji: "ğŸ¦Š" },
            { nombre: "Narval", sonido: "Click", emoji: "ğŸ³" }, { nombre: "Reno / CaribÃº", sonido: "Snort", emoji: "ğŸ¦Œ" },
            { nombre: "Beluga", sonido: "Melon", emoji: "ğŸ‹" },
            { nombre: "BÃºho Nival", sonido: "Hoot", emoji: "ğŸ¦‰" }, { nombre: "Liebre Ãrtica", sonido: "Thump", emoji: "ğŸ‡" },
            { nombre: "Lobo Ãrtico", sonido: "Howl", emoji: "ğŸº" }, { nombre: "PingÃ¼ino Emperador", sonido: "Squawk", emoji: "ğŸ§" },
            { nombre: "Lince Canadiense", sonido: "Meow", emoji: "ğŸˆ" },
            { nombre: "Kodiak", sonido: "Roar", emoji: "ğŸ»" }, { nombre: "Orca", sonido: "Whistle", emoji: "ğŸ‹" },
            { nombre: "Alce", sonido: "Bellow", emoji: "ğŸ¦Œ" }, { nombre: "Rata almizclera", sonido: "Splash", emoji: "ğŸ­" },
            { nombre: "Marmota Alpina", sonido: "Whistle", emoji: "ğŸ¿ï¸" }
        ],
        bosque: [
            { nombre: "Oso Pardo", sonido: "Roar", emoji: "ğŸ»" }, { nombre: "BÃºho Real", sonido: "Hoot", emoji: "ğŸ¦‰" },
            { nombre: "Venado cola blanca", sonido: "Snort", emoji: "ğŸ¦Œ" }, { nombre: "Mapache", sonido: "Chirr", emoji: "ğŸ¦" },
            { nombre: "Lobo Gris", sonido: "Howl", emoji: "ğŸº" },
            { nombre: "Ardilla", sonido: "Chirp", emoji: "ğŸ¿ï¸" }, { nombre: "TejÃ³n", sonido: "Hiss", emoji: "ğŸ¦¡" },
            { nombre: "Zorro Rojo", sonido: "Yelp", emoji: "ğŸ¦Š" }, { nombre: "JabalÃ­", sonido: "Oink", emoji: "ğŸ—" },
            { nombre: "Mofeta", sonido: "Stink", emoji: "ğŸ¦¨" },
            { nombre: "PuercoespÃ­n", sonido: "Quill", emoji: "ğŸ¦”" }, { nombre: "Castor Canadiense", sonido: "Slap", emoji: "ğŸ¦«" },
            { nombre: "PÃ¡jaro Carpintero", sonido: "Tap Tap", emoji: "ğŸ¦" }, { nombre: "Comadreja", sonido: "Hiss", emoji: "ğŸª±" },
            { nombre: "Gato MontÃ©s", sonido: "Meow", emoji: "ğŸˆ" }
        ],
        montana: [
            { nombre: "Cabra MontÃ©s", sonido: "Bleat", emoji: "ğŸ" }, { nombre: "CÃ³ndor Andino", sonido: "Hiss", emoji: "ğŸ¦…" },
            { nombre: "Leopardo de las Nieves", sonido: "Chuff", emoji: "ğŸ†" }, { nombre: "Puma", sonido: "Scream", emoji: "ğŸˆ" },
            { nombre: "Ãguila Real", sonido: "Screech", emoji: "ğŸ¦…" },
            { nombre: "Borrego CimarrÃ³n", sonido: "Baaa", emoji: "ğŸ‘" }, { nombre: "Oso Grizzly", sonido: "Grunt", emoji: "ğŸ»" },
            { nombre: "Lama", sonido: "Spit", emoji: "ğŸ¦™" }, { nombre: "MuflÃ³n", sonido: "Bleat", emoji: "ğŸ‘" },
            { nombre: "Yak", sonido: "Moo", emoji: "ğŸƒ" },
            { nombre: "Bisonte", sonido: "Snort", emoji: "ğŸ¦¬" }, { nombre: "Armadillo", sonido: "Click", emoji: "ğŸ¦”" },
            { nombre: "Chinchilla", sonido: "Squeak", emoji: "ğŸ¹" }, { nombre: "VicÃºÃ±a", sonido: "Snort", emoji: "ğŸ¦™" },
            { nombre: "Guepardo", sonido: "Chirp", emoji: "ğŸ†" }
        ],
        rio: [
            { nombre: "Nutria de RÃ­o", sonido: "Squeal", emoji: "ğŸ¦¦" }, { nombre: "Castor", sonido: "Slap", emoji: "ğŸ¦«" },
            { nombre: "Pez Gato", sonido: "Meow", emoji: "ğŸŸ" }, { nombre: "CaimÃ¡n", sonido: "Bellow", emoji: "ğŸŠ" },
            { nombre: "LibÃ©lula", sonido: "Buzz", emoji: "ğŸ¦Ÿ" },
            { nombre: "Rana ArborÃ­cola", sonido: "Croak", emoji: "ğŸ¸" }, { nombre: "Tortuga de agua dulce", sonido: "Hiss", emoji: "ğŸ¢" },
            { nombre: "Garza", sonido: "Squawk", emoji: "ğŸ¦†" }, { nombre: "Sapo ComÃºn", sonido: "Ribbit", emoji: "ğŸ¸" },
            { nombre: "PiraÃ±a", sonido: "Bite", emoji: "ğŸŸ" },
            { nombre: "PelÃ­cano", sonido: "Gulp", emoji: "é¹ˆ" }, { nombre: "Lombriz", sonido: "Wiggle", emoji: "ğŸ›" },
            { nombre: "Cangrejo de rÃ­o", sonido: "Click", emoji: "ğŸ¦€" }, { nombre: "HipopÃ³tamo", sonido: "Grunt", emoji: "ğŸ¦›" },
            { nombre: "TritÃ³n", sonido: "Splash", emoji: "ğŸ¦" }
        ]
    };
    const catEmojis = { 
        granja: 'ğŸ¡', mar: 'ğŸŒŠ', selva: 'ğŸ¦', 
        desierto: 'ğŸœï¸', artico: 'ğŸ§Š', bosque: 'ğŸŒ³', montana: 'â›°ï¸', rio: 'ğŸï¸' 
    };
    const ALL_CATEGORIES = Object.keys(db);

    // --- VARIABLES DE ESTADO ---
    let perfiles = [];
    let perfilActual = null;
    let usuarioGoogle = null;

    let estado = {
        cat: 'granja', nivel: 1, puntos: 0, 
        progreso: ALL_CATEGORIES.reduce((acc, c) => ({ ...acc, [c]: 0 }), {}),
        animalesCompletados: 0, 
        totalAnimalesNivel: NUM_ANIMALES_POR_NIVEL,
        metaPuntosNivel: NUM_ANIMALES_POR_NIVEL * 2 * 10 
    };

    // --- FUNCIONES DE AUTENTICACIÃ“N GOOGLE ---
    
    // Hacemos las funciones accesibles globalmente (window)
    window.loginConGoogle = function() {
        signInWithPopup(auth, provider)
            .then((result) => {
                const user = result.user;
                console.log("Usuario logueado:", user.displayName);
                gestionarUsuarioGoogle(user);
            }).catch((error) => {
                console.error("Error login:", error);
                alert("Hubo un error al conectar con Google: " + error.message);
            });
    }

    function gestionarUsuarioGoogle(user) {
        usuarioGoogle = user;
        window.cargarPerfiles();
        
        // Buscar perfil por UID de Google
        let perfilEncontrado = perfiles.find(p => p.googleUid === user.uid);
        
        if (!perfilEncontrado) {
            // Crear perfil nuevo si no existe
            perfilEncontrado = {
                nombre: user.displayName || "Explorador Google",
                puntos: 0,
                progreso: ALL_CATEGORIES.reduce((acc, c) => ({ ...acc, [c]: 0 }), {}),
                catActual: 'granja',
                nivelActual: 1,
                googleUid: user.uid,
                foto: user.photoURL
            };
            perfiles.push(perfilEncontrado);
            guardarPerfiles();
        }

        perfilActual = perfilEncontrado;
        window.iniciarJuego(true);
    }

    // --- GESTIÃ“N DE PERFILES ---
    
    window.cargarPerfiles = function() {
        detenerSonidoAnterior(); 
        const perfilesJSON = localStorage.getItem('safariSonidosPerfiles');
        perfiles = perfilesJSON ? JSON.parse(perfilesJSON) : [];
        
        const select = document.getElementById('select-perfil');
        const inputNuevo = document.getElementById('input-nombre-nuevo');
        select.innerHTML = '';
        
        const optSeleccionar = document.createElement('option');
        optSeleccionar.value = "";
        optSeleccionar.textContent = perfiles.length === 0 ? "--- Crea un nuevo explorador ---" : "--- Elige un explorador ---";
        select.appendChild(optSeleccionar);
        
        perfiles.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.nombre; 
            const esGoogle = p.googleUid ? " (G)" : "";
            opt.textContent = `${p.nombre}${esGoogle} - Puntos: ${p.puntos}`;
            if(p.googleUid) opt.setAttribute('data-uid', p.googleUid);
            select.appendChild(opt);
        });
        
        perfilActual = null;
        inputNuevo.value = '';
        
        if (perfiles.length === 0) {
            inputNuevo.style.display = 'block';
        } else {
            inputNuevo.style.display = 'none';
        }
        document.getElementById('btn-eliminar-perfil').style.display = 'none';
        select.selectedIndex = 0; 
    }

    function guardarPerfiles() {
        localStorage.setItem('safariSonidosPerfiles', JSON.stringify(perfiles));
    }

    window.seleccionarPerfil = function() {
        const select = document.getElementById('select-perfil');
        const nombreSeleccionado = select.value;
        const selectedOption = select.options[select.selectedIndex];
        const uid = selectedOption.getAttribute('data-uid');
        const inputNuevo = document.getElementById('input-nombre-nuevo');

        if (nombreSeleccionado) {
            if(uid) {
                perfilActual = perfiles.find(p => p.googleUid === uid);
            } else {
                perfilActual = perfiles.find(p => p.nombre === nombreSeleccionado && !p.googleUid);
            }
            
            estado.puntos = perfilActual.puntos;
            estado.progreso = perfilActual.progreso;
            estado.cat = perfilActual.catActual;
            estado.nivel = perfilActual.nivelActual;
            
            inputNuevo.value = ''; 
            inputNuevo.style.display = 'none';
            document.getElementById('btn-eliminar-perfil').style.display = 'block';
        } else {
            perfilActual = null;
            inputNuevo.style.display = 'block';
            document.getElementById('btn-eliminar-perfil').style.display = 'none';
            estado.cat = 'granja';
            estado.nivel = 1;
            estado.puntos = 0;
        }
    }

    window.eliminarPerfil = function() {
        if (!perfilActual) return;
        if (confirm(`Â¿Borrar a ${perfilActual.nombre}?`)) {
            if(perfilActual.googleUid) {
                perfiles = perfiles.filter(p => p.googleUid !== perfilActual.googleUid);
            } else {
                perfiles = perfiles.filter(p => p.nombre !== perfilActual.nombre);
            }
            perfilActual = null;
            guardarPerfiles();
            window.cargarPerfiles();
        }
    }

    function actualizarPerfil() {
        if (perfilActual) {
            perfilActual.puntos = estado.puntos;
            perfilActual.progreso = estado.progreso;
            perfilActual.catActual = estado.cat;
            perfilActual.nivelActual = estado.nivel;
            guardarPerfiles();
        }
    }

    // --- FUNCIONES PRINCIPALES DEL JUEGO ---

    window.iniciarJuego = function(esLoginGoogle = false) {
        const inputNuevo = document.getElementById('input-nombre-nuevo');
        const nombreNuevo = inputNuevo.value.trim().toUpperCase();

        if (!esLoginGoogle) {
            if (nombreNuevo) {
                if (perfiles.some(p => p.nombre.toUpperCase() === nombreNuevo)) {
                    return alert(`Â¡El nombre "${nombreNuevo}" ya existe!`);
                }
                perfilActual = {
                    nombre: nombreNuevo,
                    puntos: 0,
                    progreso: ALL_CATEGORIES.reduce((acc, c) => ({ ...acc, [c]: 0 }), {}),
                    catActual: 'granja',
                    nivelActual: 1
                };
                perfiles.push(perfilActual);
                guardarPerfiles();
                
                estado.puntos = 0;
                estado.progreso = ALL_CATEGORIES.reduce((acc, c) => ({ ...acc, [c]: 0 }), {});
                estado.cat = 'granja';
                estado.nivel = 1;
            } else if (!perfilActual) {
                return alert("Selecciona un explorador o usa Google.");
            }
        }
        
        document.getElementById('nombre-jugador').innerText = perfilActual.nombre.toUpperCase();
        document.getElementById('modal').style.display = 'none';
        document.getElementById('pantalla-inicio').style.display = 'none';
        document.getElementById('juego').style.display = 'flex';
        
        cargarNivel();
    }

    window.volverAlMenu = function() {
        if (confirm("Â¿Volver al menÃº?")) {
            document.getElementById('juego').style.display = 'none';
            document.getElementById('pantalla-inicio').style.display = 'flex';
            window.cargarPerfiles();
        }
    }

    window.cambiarCategoria = function(nuevaCat) {
        const btn = document.getElementById(`cat-${nuevaCat}`);
        if(btn.classList.contains('desbloqueada') && estado.cat !== nuevaCat) {
            estado.cat = nuevaCat;
            estado.nivel = estado.progreso[nuevaCat] < 3 ? estado.progreso[nuevaCat] + 1 : 3; 
            cargarNivel();
        }
    }

    function cargarNivel() {
        if (!perfilActual) return; 
        if (estado.cat === 'granja' && estado.puntos === 0 && estado.nivel !== 1) estado.nivel = 1;
        
        const tablero = document.getElementById('tablero');
        const panel = document.getElementById('panel-opciones');
        tablero.innerHTML = '';
        panel.innerHTML = '';
        
        const inicio = (estado.nivel - 1) * NUM_ANIMALES_POR_NIVEL;
        const animalesNivel = db[estado.cat].slice(inicio, inicio + NUM_ANIMALES_POR_NIVEL);
        
        estado.totalAnimalesNivel = animalesNivel.length;
        estado.animalesCompletados = 0; 
        estado.metaPuntosNivel = estado.totalAnimalesNivel * 2 * 10; 

        document.getElementById('titulo-nivel').innerText = `${estado.cat.toUpperCase()} - NIVEL ${estado.nivel}`;
        document.getElementById('titulo-nivel-emoji').innerText = catEmojis[estado.cat];

        animalesNivel.forEach((animal, i) => {
            const card = document.createElement('div');
            card.className = 'tarjeta';
            card.id = `card-${i}`;
            const huecos = crearHueco(animal.nombre, 'texto') + crearHueco(animal.sonido, 'sonido');
            card.innerHTML = `<div class="emoji-grande" onclick="window.hablar('${animal.sonido}')">${animal.emoji}</div>${huecos}`;
            tablero.appendChild(card);
        });

        let opciones = [];
        animalesNivel.forEach(animal => {
            opciones.push({ val: animal.nombre, tipo: 'texto' });
            opciones.push({ val: animal.sonido, tipo: 'sonido' });
        });
        opciones.sort(() => Math.random() - 0.5);

        opciones.forEach(op => {
            const ficha = document.createElement('div');
            ficha.className = 'ficha';
            ficha.draggable = true;
            ficha.id = 'ficha-' + Math.random().toString(36).substr(2,9);
            if(op.tipo === 'sonido') {
                ficha.innerHTML = `<div class="btn-play-mini" onclick="window.hablar('${op.val}')">ğŸ”Š</div> ${op.val.toUpperCase()}`;
            } else {
                ficha.innerHTML = op.val.toUpperCase();
            }
            ficha.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text', op.val);
                e.dataTransfer.setData('id', ficha.id);
            });
            panel.appendChild(ficha);
        });
        
        actualizarStats(0, estado.animalesCompletados);
        actualizarSidebar();
        actualizarPerfil(); 
    }

    function crearHueco(target, tipo) {
        const etiqueta = tipo === 'texto' ? 'NOMBRE' : 'SONIDO';
        return `<div class="zona-drop" data-target="${target}">${etiqueta}</div>`;
    }

    // --- AUDIO ---
    let audioActual = null; 
    let timerAudio = null; 

    function detenerSonidoAnterior() {
        if (audioActual) {
            audioActual.pause();
            audioActual.currentTime = 0;
            audioActual = null;
        }
        window.speechSynthesis.cancel();
        if (timerAudio) {
            clearTimeout(timerAudio);
            timerAudio = null;
        }
    }

    window.hablar = function(texto) {
        detenerSonidoAnterior();
        let animalEncontrado = db[estado.cat].find(a => a.sonido === texto);
        if (animalEncontrado && animalEncontrado.archivo) {
            const audioUrl = GITHUB_URL + animalEncontrado.archivo;
            audioActual = new Audio(audioUrl);
            audioActual.play().catch(error => {
                window.usarVozRobot(texto);
            });
            timerAudio = setTimeout(() => {
                if (audioActual) { audioActual.pause(); audioActual = null; }
            }, 5000); 
        } else {
            window.usarVozRobot(texto);
        }
    }

    window.usarVozRobot = function(texto) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(texto);
        u.lang = 'es-ES';
        window.speechSynthesis.speak(u);
    }

    // --- UI HELPERS ---
    
    function actualizarStats(puntosNivel, animalesListos) {
        const totalFichasNivel = estado.totalAnimalesNivel * 2;
        const fichasCompletadas = puntosNivel / 10;
        const porcentaje = totalFichasNivel > 0 ? Math.round((fichasCompletadas / totalFichasNivel) * 100) : 0;
        
        document.getElementById('puntuacion-total-lateral').innerText = estado.puntos; 
        document.getElementById('puntos-nivel').innerText = puntosNivel;
        document.getElementById('meta-nivel').innerText = estado.metaPuntosNivel;
        document.getElementById('listos-nivel').innerText = `${animalesListos}/${estado.totalAnimalesNivel}`;
        
        document.getElementById('progreso-bar').style.width = `${porcentaje}%`;
        document.getElementById('progreso-porcentaje').innerText = `${porcentaje}%`;
        actualizarPerfil();
    }

    function actualizarSidebar() {
        ALL_CATEGORIES.forEach((c, i) => {
            const btn = document.getElementById(`cat-${c}`);
            const stars = document.getElementById(`star-${c}`);
            btn.classList.remove('activa');
            if(estado.cat === c) btn.classList.add('activa');

            let s = '';
            for(let k=0; k<3; k++) {
                s += k < estado.progreso[c] ? '<span class="estrella ganada">â˜…</span>' : '<span class="estrella">â˜†</span>';
            }
            stars.innerHTML = s;

            if(i > 0) {
                const prev = ALL_CATEGORIES[i-1];
                if(estado.progreso[prev] >= 3) {
                    btn.classList.add('desbloqueada');
                    let spanText = btn.querySelector('span').innerText;
                    if(spanText.includes('ğŸ”’')) btn.querySelector('span').innerText = spanText.replace(' ğŸ”’','');
                } else if (!btn.classList.contains('desbloqueada')) {
                    if(!btn.querySelector('span').innerText.includes('ğŸ”’')) btn.querySelector('span').innerText += ' ğŸ”’';
                }
            }
        });
        actualizarPerfil();
    }

    // --- GAMEPLAY LOGIC ---

    document.addEventListener('dragover', e => {
        if(e.target.classList.contains('zona-drop')) {
            e.preventDefault();
            e.target.classList.add('hover');
        }
    });
    document.addEventListener('dragleave', e => {
        if(e.target.classList.contains('zona-drop')) e.target.classList.remove('hover');
    });
    document.addEventListener('drop', e => {
        if(e.target.classList.contains('zona-drop')) {
            e.preventDefault();
            const zone = e.target;
            zone.classList.remove('hover');
            
            const val = e.dataTransfer.getData('text');
            const id = e.dataTransfer.getData('id');
            const target = zone.getAttribute('data-target');

            if(val === target) {
                zone.style.background = '#4A4E69';
                zone.style.color = '#A1FFCE';
                zone.classList.add('acierto');
                zone.innerHTML = `âœ… ${val.toUpperCase()}`;
                
                estado.puntos += 10;
                const puntosNivelActual = parseInt(document.getElementById('puntos-nivel').innerText) + 10;
                
                const ficha = document.getElementById(id);
                if(ficha) {
                    ficha.classList.add('usada');
                    setTimeout(() => ficha.remove(), 400);
                }

                const parent = zone.parentElement;
                const zonas = parent.querySelectorAll('.zona-drop');
                let completa = true;
                zonas.forEach(z => { if(!z.innerHTML.includes('âœ…')) completa = false; });

                if(completa) estado.animalesCompletados++; 
                actualizarStats(puntosNivelActual, estado.animalesCompletados);

                if(completa) {
                    setTimeout(() => {
                        parent.classList.add('completada');
                        setTimeout(() => {
                            parent.style.visibility = 'hidden';
                            if(estado.animalesCompletados === estado.totalAnimalesNivel) victoria(puntosNivelActual);
                        }, 700);
                    }, 500);
                }
            } else {
                zone.classList.add('error');
                setTimeout(() => zone.classList.remove('error'), 500);
            }
        }
    });

    function victoria(puntosNivel) {
        if(estado.nivel > estado.progreso[estado.cat]) estado.progreso[estado.cat] = estado.nivel;
        const esCategoriaCompleta = estado.nivel === 3;
        document.getElementById('modal-titulo').innerText = esCategoriaCompleta ? "Â¡CATEGORÃA COMPLETA! ğŸ†" : "Â¡NIVEL SUPERADO! âœ¨";
        document.getElementById('modal-puntos').innerText = `Â¡Sumaste ${puntosNivel} PUNTOS!`;
        document.getElementById('modal').style.display = 'flex';
        actualizarPerfil();
    }

    window.siguiente = function() {
        document.getElementById('modal').style.display = 'none';
        if(estado.nivel < 3) {
            estado.nivel++;
            cargarNivel();
        } else {
            const idx = ALL_CATEGORIES.indexOf(estado.cat);
            if(idx < ALL_CATEGORIES.length - 1) {
                estado.cat = ALL_CATEGORIES[idx+1];
                estado.nivel = 1;
                cargarNivel();
            } else {
                alert("Â¡JUEGO COMPLETADO! ğŸ¥‡");
                window.volverAlMenu();
            }
        }
    }

    // --- CARGA INICIAL ---
    window.onload = function() {
        window.cargarPerfiles();
    }
</script>
</body>
</html>